name: CI Workflow - Build & Test Debian Package

on:
  push:
    branches:
      - "**"
  pull_request:
    branches:
      - "**"

jobs:
  build-and-test-deb:
    runs-on: ubuntu-latest

    env:
      DB_USER: ${{ secrets.DB_USER }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      DB_HOST: ${{ secrets.DB_HOST }}
      DB_PORT: ${{ secrets.DB_PORT }}
      DB_NAME: ${{ secrets.DB_NAME }}

    steps:
    # Step 1: Check out the repository
    - name: Checkout repository
      uses: actions/checkout@v3

    # Step 2: Install required tools
    - name: Install packaging and systemd tools
      run: sudo apt-get update && sudo apt-get install -y dpkg-dev systemd python3 python3-pip

    # Step 3: Build .deb package
    - name: Build .deb package
      run: |
        mkdir -p debian_package/{DEBIAN,opt/arculus-devops-challenge/etc/systemd/system}
        pip install --target=debian_package/opt/arculus-devops-challenge -r requirements.txt
        cp -r apps tests debian_package/opt/arculus-devops-challenge/

        # Create the systemd service file
        echo -e "[Unit]
        Description=Arculus DevOps Flask Application
        After=network.target

        [Service]
        User=www-data
        Group=www-data
        WorkingDirectory=/opt/arculus-devops-challenge
        ExecStart=/usr/bin/python3 /opt/arculus-devops-challenge/apps/main.py
        Restart=always
        RestartSec=5

        [Install]
        WantedBy=multi-user.target" > debian_package/etc/systemd/system/arculus-devops.service

        # Create the control file
        echo -e "Package: arculus-devops-challenge\nVersion: 1.0.0\nSection: base\nPriority: optional\nArchitecture: all\nMaintainer: Your Name <your.email@example.com>\nDescription: Flask app with /health and /orders endpoints" > debian_package/DEBIAN/control
        dpkg-deb --build debian_package

    # Step 4: Test .deb package installation
    - name: Test .deb package installation
      run: |
        sudo dpkg -i debian_package.deb
        sudo apt-get install -f -y
        if [ -d "/opt/arculus-devops-challenge" ]; then 
          echo "App installed correctly"; 
        else 
          echo "App installation failed"; 
          exit 1; 
        fi
        if [ -f "/etc/systemd/system/arculus-devops.service" ]; then
          echo "Systemd file exists";
        else
          echo "Systemd file missing";
          exit 1;
        fi

    # Step 5: Upload the .deb file as an artifact
    - name: Upload .deb package
      uses: actions/upload-artifact@v4
      with:
        name: arculus-devops-challenge.deb
        path: debian_package.deb